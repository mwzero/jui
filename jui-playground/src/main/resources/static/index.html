<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JUI Playground</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
    
        html, body {
            height: 100%;
            margin: 0;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s;
            position: relative; /* Per consentire la sovrapposizione */
        }

        #editor {
            flex-grow: 1;
            padding: 20px;
        }

        .code-editor {
            width: 100%;
            height: 100%;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            padding: 10px;
            border-radius: 5px;
        }

        #preview-container {
            width: 100%;
            height: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        #console {
        	white-space: pre-wrap; /* Mantiene i ritorni a capo e gli spazi */
            background-color: #1e1e1e;
            color: #33ff33;
            font-family: monospace;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            border-top: 2px solid #333;
            display: none; /* La console è nascosta al caricamento */
        }
        
        footer {
            background-color: #282c34;
            color: white;
            text-align: center;
            padding: 5px 15px;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .toggle-link {
            color: #007bff;
            cursor: pointer;
            text-decoration: underline;
        }

        /* Header modificato */
        header {
            background-color: #343a40;
            color: white;
            padding: 10px 15px;
            display: flex;
            align-items: center;
        }

        header h1 {
            font-size: 1.25rem; /* Rimpicciolito */
            margin-left: 15px;
        }

        .fa-bars {
            cursor: pointer;
            font-size: 1.5rem;
        }

        /* Sidebar Collassabile */
        #sidebar {
            height: 100%;
            width: 250px;
            position: fixed;
            top: 0;
            left: -250px; /* Sidebar nascosta fuori schermo */
            background-color: #343a40;
            color: white;
            padding-top: 60px;
            overflow-x: hidden;
            transition: left 0.3s;
        }

        #sidebar a {
            padding: 10px 15px;
            text-decoration: none;
            font-size: 1.1rem;
            color: white;
            display: block;
        }

        #sidebar a:hover {
            background-color: #575757;
        }

        #sidebar.active {
            left: 0; /* Sidebar visibile sovrapponendosi */
        }

        /* Nascondere il contenuto del main content quando sidebar è aperta */
        #main-content.sidebar-collapsed {
            margin-left: 0;
        }
        
        #code-editor {
	      height: 65vh; /* Occupa il 65% dell'altezza della finestra */
	      //width: 100%;
	    }

    </style>
</head>
<body>

	<!-- Sidebar -->
	<div id="sidebar">
	    <a href="#">Dashboard</a>
	    <a href="#">Projects</a>
	    <a href="#">Settings</a>
	    <a href="#">Help</a>
	</div>
	
	<!-- Header -->
	<header>
	    <i class="fas fa-bars" id="toggle-sidebar"></i>
	    <h1>JUI Playground</h1>
	</header>
	
	<div id="main-content" class="container-fluid">
	    <div id="editor" class="container-fluid">
	        <div class="row">
	            <!-- Primo editor con dropdown -->
	            <div class="col-md-6">
	                <div class="d-flex justify-content-between align-items-center mb-2">
	                	
	                	<button id="run-btn" class="btn btn-primary btn-sm">Run Code</button>
	                    <button id="save-btn" class="btn btn-secondary btn-sm">Save Code</button>
	                    
	                    <label for="example-selector">Select Example:</label>
	                    <select id="example-selector" class="form-select form-select-sm w-50">
	                    
	                    
	                    </select>
	                </div>
	                <div id="code-editor"></div>
	            </div>
	            
	            <div class="col-md-6">
	                <div class="d-flex justify-content-between align-items-center mb-2">
	                    <input type="text" id="url-input" class="form-control-sm w-75" placeholder="Enter URL...">
	                    <button id="open-browser-btn" class="btn btn-info btn-sm">Open in Browser</button>
	                </div>
	                <iframe id="preview-container" class="code-editor" title="Website Preview"></iframe>
	            </div>
	        </div>
	    </div>
	    
	    <div id="console" class="container-fluid mt-3">
	    </div>
	</div>
	
	<footer class="mt-auto">
	    <span id="toggle-console" class="toggle-link">Show Console</span>
	    <span>Web IDE Simulation &copy; 2024</span>
	</footer>

	<!-- Bootstrap JS, Popper.js, and dependencies -->
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.23.0/min/vs/loader.min.js"></script>
  
	<script>
	    let currentFileName = ""; // Variabile per mantenere il nome del file selezionato
	
	    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.23.0/min/vs' } });
	    require(['vs/editor/editor.main'], function () {
	      window.editor = monaco.editor.create(document.getElementById('code-editor'), {
	        value: '',
	        language: 'java',
	        automaticLayout: true,
	        theme: "vs-dark",
	        lineNumbers: "on"
			
	      });
	    });
	    
	    function loadExamples() {
	      fetch('/api/examples')
	        .then(response => response.json())
	        .then(data => {
	          const exampleList = document.getElementById('example-selector');
	          exampleList.innerHTML = ""; // Pulisci l'elenco degli esempi prima di aggiornare
	          
	          const optionDefault = document.createElement('option');
              optionDefault.textContent = "choose a file";
              optionDefault.value = "";
              exampleList.appendChild(optionDefault);
	            
	          data.forEach(example => {
	            const option = document.createElement('option');
	            option.textContent = example.name;
	            option.value = example.name;
	            exampleList.appendChild(option);
	          });
	        });
	    }
	    
	    function loadExampleCode(fileName) {
	      fetch(`/api/examples/${fileName}`)
	        .then(response => response.text())
	        .then(code => {
	          editor.setValue(code);
	          currentFileName = fileName; 
	          runButton.disabled = false; 
	        });
	    }
    
	    window.onload = loadExamples;
	    
	</script>


<!-- Bootstrap JS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const runButton = document.getElementById('run-btn');
    const saveButton = document.getElementById('save-btn');
    const outputDiv = document.getElementById('console');
    const previewContainer = document.getElementById('preview-container');
    const urlInput = document.getElementById('url-input');
    const openBrowserButton = document.getElementById('open-browser-btn');
    const exampleSelector = document.getElementById('example-selector');
    const consoleDiv = document.getElementById('console');
    const toggleConsoleLink = document.getElementById('toggle-console');
    const sidebar = document.getElementById('sidebar');
    const toggleSidebarButton = document.getElementById('toggle-sidebar');
    const mainContent = document.getElementById('main-content');

    saveButton.addEventListener('click', function () {
        
        const code = editor.getValue();

	  	let fileName;
		if (currentFileName) fileName = currentFileName;
	    else fileName = "CustomCode.java";
		
		fileName = prompt("Inserisci il nome del file da salvare", fileName);  // Altrimenti chiedi all'utente il nome
	
		if (fileName) {
    		fetch('/api/save', {
      			method: 'POST',
      			headers: { 'Content-Type': 'application/json' },
      			body: JSON.stringify({ code, fileName })
    		})
    		.then(response => response.json())
    		.then(data => {
      			outputDiv.innerHTML+= data.message  + "\n";
      			loadExamples();
      			currentFileName = fileName; 
      			runButton.disabled = false; 
    		});
  		}
	});
	
	runButton.addEventListener('click', function () {
      if (!currentFileName) {
        outputDiv.innerHTML  = "Salva prima il file per poterlo eseguire.";
        return;
      }

      outputDiv.innerHTML   = "Il codice sta venendo compilato ed eseguito, attendere prego...";

      // Effettua la richiesta per compilare ed eseguire il codice
      fetch('/api/compile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fileName: currentFileName })
      })
      .then(response => {
        if (!response.ok) {
          return response.text().then(errorMessage => {
            throw new Error(errorMessage);
          });
        }
        return response.text();
      })
      .then(output => {
        outputDiv.innerHTML  = output;
        
		// Specifica l'URL della pagina da caricare nell'iframe
	    previewContainer.src = 'http://127.0.0.1:8080/index.html';
	    urlInput.value = 'http://127.0.0.1:8080/index.html';
	    
	  })
      
      .catch(error => {
        // Mostra l'errore nella console di output
        outputDiv.innerHTML  = "Errore durante la compilazione o esecuzione: " + error.message;
      });
    });
    
    // Funzione per caricare un esempio predefinito nel primo editor
    exampleSelector.addEventListener('change', function () {
        const selectedExample = exampleSelector.value;
        if (selectedExample) {
	        loadExampleCode(selectedExample);
        }
    });

    // Funzione per aprire il sito in una nuova finestra del browser
    openBrowserButton.addEventListener('click', function () {
        const url = urlInput.value;
        if (url) {
            window.open(url, '_blank');
        } else {
            alert('Please enter a valid URL');
        }
    });

    // Funzione per mostrare/nascondere la console
    toggleConsoleLink.addEventListener('click', function () {
        if (consoleDiv.style.display === 'block') {
            consoleDiv.style.display = 'none';
            toggleConsoleLink.textContent = 'Hide Console';
        } else {
            consoleDiv.style.display = 'block';
            toggleConsoleLink.textContent = 'Show Console';
        }
    });

    // Funzione per mostrare/nascondere la sidebar
    toggleSidebarButton.addEventListener('click', function () {
        if (sidebar.classList.contains('active')) {
            sidebar.classList.remove('active');
        } else {
            sidebar.classList.add('active');
        }
    });

</script>

	<script>
    
	    var socket;
	
	    function connectWebSocket() {
	    
	        socket = new WebSocket("ws://localhost:9090/ws");
	        socket.onopen = function () {
	            console.log("Connessione WebSocket aperta.");
	        };
	
	        socket.onmessage = function (event) {
	        	outputDiv.innerHTML+= event.data  + "\n";
	            outputDiv.scrollTop = outputDiv.scrollHeight;
	        };
	
	        socket.onclose = function () {
	            console.log("Connessione WebSocket chiusa.");
	        };
	
	        socket.onerror = function (error) {
	            console.log("Errore WebSocket: " + error);
	        };
	    }
	    
		connectWebSocket();

	</script>

</body>
</html>
