<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jui Playground</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body, html {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden; /* Evita lo scrolling */
    }
    .container-fluid {
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    .row {
      flex-grow: 1;
      display: flex;
      overflow: hidden;
    }
    #editor {
      height: 65vh; /* Occupa il 65% dell'altezza della finestra */
      //width: 100%;
    }
    #preview {
      height: 65vh; /* Occupa il 65% dell'altezza della finestra */
      background-color: #f4f4f4;
      padding: 10px;
      overflow: auto;
    }
    #output {
      height: 25vh;
      background-color: black;
      color: white;
      padding: 10px;
      overflow: auto;
      font-family: monospace;
    }
    .sidebar {
      height: 65vh; /* Altezza della lista degli esempi */
      overflow-y: auto;
    }
  </style>
</head>
<body>

	<div class="container-fluid">
	    <div class="row">
	      <div class="col-md-3">
	        <h3>Esempi</h3>
	        <ul id="exampleList" class="list-group">
	          <!-- Elenco degli esempi -->
	        </ul>
	      </div>
	      <div class="col-md-6">
	        <h3>Editor di Codice</h3>
	        <div id="editor"></div>
	        <button id="runButton" class="btn btn-success mt-3">Esegui</button>
	        <button id="saveButton" class="btn btn-primary mt-3">Salva Codice</button>
	      </div>
	      <div class="col-md-3">
	        <h3>Output</h3>
	        <div id="preview"></div>
	      </div>
	    </div>
	 
	    <div class="row">
	      <div class="col-md-12">
	        <div id="output"></div>
	      </div>
	    </div>
  </div>

  <!-- Bootstrap JS, Popper.js, and dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.23.0/min/vs/loader.min.js"></script>
  
  <script>
    let currentFileName = ""; // Variabile per mantenere il nome del file selezionato

    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.23.0/min/vs' } });
    require(['vs/editor/editor.main'], function () {
      window.editor = monaco.editor.create(document.getElementById('editor'), {
        value: '',
        language: 'java'
      });
    });

    function loadExamples() {
      fetch('/api/examples')
        .then(response => response.json())
        .then(data => {
          const exampleList = document.getElementById('exampleList');
          exampleList.innerHTML = ""; // Pulisci l'elenco degli esempi prima di aggiornare
          data.forEach(example => {
            const li = document.createElement('li');
            li.className = 'list-group-item';
            li.textContent = example.name;
            li.onclick = () => loadExampleCode(example.fileName);
            exampleList.appendChild(li);
          });
        });
    }

    function loadExampleCode(fileName) {
      fetch(`/api/examples/${fileName}`)
        .then(response => response.text())
        .then(code => {
          editor.setValue(code);
          currentFileName = fileName; // Memorizza il nome del file selezionato
          document.getElementById('runButton').disabled = false; // Abilita il pulsante "Esegui" se è stato caricato un file esistente
        });
    }

    document.getElementById('saveButton').onclick = function () {
      const code = editor.getValue();
      
      // Usa il nome del file selezionato, altrimenti chiedi all'utente di inserirne uno
  	let fileName;
	if (currentFileName) {
		fileName = currentFileName;  // Se esiste un file selezionato, usalo
    } else {
		fileName = "CustomCode.java";
	}
	
	fileName = prompt("Inserisci il nome del file da salvare", fileName);  // Altrimenti chiedi all'utente il nome

      if (fileName) {
        fetch('/api/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code, fileName })
        })
        .then(response => response.json())
        .then(data => {
          document.getElementById('output').textContent = data.message;
          loadExamples();
          currentFileName = fileName; // Memorizza il nome del file salvato
          document.getElementById('runButton').disabled = false; // Abilita il pulsante "Esegui" dopo il salvataggio
        });
      }
    };

    document.getElementById('runButton').onclick = function () {
      if (!currentFileName) {
        document.getElementById('output').textContent = "Salva prima il file per poterlo eseguire.";
        return;
      }

      // Mostra un messaggio di avvio della compilazione/esecuzione nella console
      document.getElementById('output').textContent = "Il codice sta venendo compilato ed eseguito, attendere prego...";

      // Effettua la richiesta per compilare ed eseguire il codice
      fetch('/api/compile', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fileName: currentFileName })
      })
      .then(response => {
        if (!response.ok) {
          return response.text().then(errorMessage => {
            throw new Error(errorMessage);
          });
        }
        return response.text();
      })
      .then(output => {
        document.getElementById('output').textContent = output;
        
         // Crea un nuovo elemento iframe
    const iframe = document.createElement('iframe');
    
    // Specifica l'URL della pagina da caricare nell'iframe
    iframe.src = 'http://127.0.0.1:8080/index.html';
    
    // Imposta alcune proprietà dell'iframe (stile, altezza, larghezza, ecc.)
    iframe.id = 'preview-frame';
    iframe.style.width = '100%';
    iframe.style.height = '80vh';
    iframe.style.border = 'none';
    
    // Aggiungi l'iframe al contenitore
    const outputContainer = document.getElementById('preview');
    outputContainer.innerHTML = ''; // Pulisci il contenuto precedente
    outputContainer.appendChild(iframe);
    
        /*
        fetch('http://127.0.0.1:8080/index.html', {
        	method: 'GET',
        	headers: { 'Content-Type': 'application/html' },
	   	})
	   	.then((response) => response.text())
	   	.then((html) => {
        	document.getElementById("preview").innerHTML = html;
        })
    	.catch((error) => {
    		document.getElementById('output').textContent = "Errore : " + error.message;
    	 });
    	 */
	  })
      
      .catch(error => {
        // Mostra l'errore nella console di output
        document.getElementById('output').textContent = "Errore durante la compilazione o esecuzione: " + error.message;
      });
    };

    window.onload = loadExamples;
  </script>

</body>
</html>
