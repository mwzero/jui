<!DOCTYPE html>
<html>
<head>

	<link rel="stylesheet" href="css/bootstrap.min.css">
	<script src="js/bootstrap.bundle.min.js"></script>
	
	<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
	
	<!--leaflet -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	
    <script>
    
        var ws = new WebSocket("ws://localhost:8025/ws/echo");

        ws.onmessage = function(event) {
            //document.getElementById("JUI").innerHTML = event.data;
            setInnerHTML(document.getElementById("JUI"), event.data);
        };

        function sendClick(id) {
            ws.send(JSON.stringify({action: "click", id: id}));
        }

        ws.onopen = function() {
        
            // Richiede il rendering iniziale al server
            ws.send(JSON.stringify({action: "init"}));
            
        };
        
        //elementMapping = ${elementMapping};
        
        function setInnerHTML(elm, html) {
        
 			  elm.innerHTML = html;
  
			  Array.from(elm.querySelectorAll("script"))
			    .forEach( oldScriptEl => {
			      const newScriptEl = document.createElement("script");
			      
			      Array.from(oldScriptEl.attributes).forEach( attr => {
			        newScriptEl.setAttribute(attr.name, attr.value) 
			      });
			      
			      const scriptText = document.createTextNode(oldScriptEl.innerHTML);
			      newScriptEl.appendChild(scriptText);
			      
			      oldScriptEl.parentNode.replaceChild(newScriptEl, oldScriptEl);
			  });
		}
		var elementMapping = [];
    
		document.addEventListener("DOMContentLoaded", function listener() {
		    const formElements = document.querySelectorAll("form input, form select, form textarea");
		
		    function handleChange(event) {
		    
		        const sourceElement = event.target;
		        
		        handleEvent(sourceElement);
			}
		
		    formElements.forEach(function(element) {
		        element.addEventListener("change", handleChange);
		        element.addEventListener("input", handleChange); 
		    });
		    
		   
		});

		/*
		* used to manage events fired by web components.
		* for example in MapChart: handleEvent({"name": "${clientId}", "value": {"lat": center.lat, "lng": center.lng, "zoom": zoom}});
		*/
		function handleEvent(sourceElement) {
		
			elementMapping.forEach((element) => {
				if ( element.source === sourceElement.name ) {
					element.commands.forEach((command) => {
						console.log(`Elemento modificato: ${sourceElement.name}, Nuovo valore: ${sourceElement.value}, Aggiornato: ${command}`);
						
						let dynamicFunction = new Function('value' , command);
						dynamicFunction(sourceElement.value);
					});
				}	
			});
		}
        
    </script>
</head>
<body>
    <div class="container" id="JUI"></div> 
</body>
</html>
